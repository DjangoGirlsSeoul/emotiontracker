<!DOCTYPE html>
<!-- saved from url=(0069)https://auduno.github.io/clmtrackr/examples/clm_emotiondetection.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Face tracker</title>

        <link href="./index_files/bootstrap.min.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <style>
        #regularKeyboard {
        display: table;
        table-layout: fixed;
        width: 100%;
        height: 96px;
    }
    #regularKeyboard div {
        display: table-cell;
        height: 96px;
    }
    .key {
        /*White key styling*/
        background: #fff;
        /*Default grayed-out look of the key*/
        border: 1px solid #3F3F3F;
        z-index: 4;
        border-bottom: 2px solid #000;
        border-top: 2px solid #000;
    }
    .innerKey {
        display: table-cell;
        height: 100px;
        width: 0px;
        z-index: 5;
    }
    .blackkey {
        position: absolute;
        /*Black key styling*/
        background: #000;
        width: 7%;
        height: 57px !important;
        /*Default grayed-out look of the key*/
        border: 1px solid #3F3F3F;
        border-top: 2px solid #000;
        z-index: 6;
        margin-left: -3.5%;
    }
    </style>
    </head>
    <body>
        <div id="content">
            <div id="regularKeyboard">
                    <div class="key chromaC c0menu keyc"></div>
                    <div class="innerKey">
                            <div class="blackkey chromaDflat c1menu"></div>
                    </div>
                    <div class="key chromaD c2menu keyd"></div>
                    <div class="innerKey">
                            <div class="blackkey chromaEflat c3menu"></div>
                    </div>
                    <div class="key chromaE c4menu keye"></div>
                    <div class="key chromaF c5menu keyf"></div>
                    <div class="innerKey">
                            <div class="blackkey chromaGflat c6menu"></div>
                    </div>
                    <div class="key chromaG c7menu keyg"></div>
                    <div class="innerKey">
                            <div class="blackkey chromaAflat c8menu"></div>
                    </div>
                    <div class="key chromaA c9menu keya"></div>
                    <div class="innerKey">
                            <div class="blackkey chromaBflat c10menu"></div>
                    </div>
                    <div class="key chromaB c11menu keyb"></div>
                    <div class="key chromaB c12menu keyn"></div>
            </div>
            <div id="controls" style="margin-top:10px;">
              <input class="btn" type="button" value="start" onclick="playMusic()" id="startbutton">
            </div>
            <script>
            var keycodeMap = {'67':'c','68': 'd','69': 'e','70': 'f','71': 'g','65': 'a','66':'b','78':'n'}
    				var gameResult = [];
    				function keyupEvent(){
    					document.addEventListener("keyup", keyDownTextField, false);
    					function keyDownTextField(e) {
    						var keyCode = e.keyCode,
    								keyCodeStr = keyCode.toString();
    						if(Object.keys(keycodeMap).indexOf(keyCodeStr) != -1){
    							gameResult.push(keycodeMap[keyCodeStr]);
    						}
    					}
    				}
            level = {{level}};
            var original_notes = ['c','d','e','f','g','a','b','n'];
            audio_json = {};
            audio_buffer_json = {};
            var audioContext = new (window.AudioContext || window.webkitAudioContext)();
            _.each(original_notes, function(n){
                var source = audioContext.createBufferSource();
                var request = new XMLHttpRequest();
                request.open('GET', './index_files/audio_files/'+n+'.wav', true);
                // request.open('GET', 'http://freewavesamples.com/files/Boom-Kick.wav', true);
                request.responseType = 'arraybuffer';
                // console.log(request.response);
                request.onload = function(){
                    audioContext.decodeAudioData(request.response, function(buffer) {
                        source.buffer = buffer;
                        audio_buffer_json[n] = buffer;
                        source.connect(audioContext.destination);
                        audio_json[n] = source;
                    });
                }
                request.send();
            });

            function playMusic() {
              _.debounce(keyupEvent(), 250);
              // var original_notes = ['c','d','e','f','g','a','b','n'];
              //
              // var audio_arr = [];
              // _.each(original_notes, function(n){
              //   var a = new Audio();
              //   a.id = n;
              //   a.src = './index_files/audio_files/'+n+'.wav';
              //   audio_arr.push(a);
              // });

              var songs = [{"speed" : 1, "notes" : [{'e': 800},{'d': 500},{'c': 400},{'d': 600},{'e': 500},{'e': 500},{'e': 500}]}, {"speed" : 2, "notes" : [{'g': 300},{'g': 300},{'a':300},{'a': 300},{'g':300},{'g':300},{'e':300}]}]
              // var note_audio_array = [];
              // _.each(songs[level].notes,function(note, idx){
              //     var note_audio = _.filter(audio_arr,function(a){
              //         return a.id == Object.keys(note)[0]
              //     });
              //     note_audio_array.push(note_audio);
              // });
              var currentTime = songs[level].speed * 1000;
              function playAudio() {
                var currentNote = songs[level].notes.shift();
                var currentTime = songs[level].speed * currentNote[Object.keys(currentNote)[0]];
                // var currentAudio = note_audio_array.shift();
                console.log('sadasda', currentNote);
                // currentAudio[level].play();
                console.log('!!!1', audio_json);
                var key = Object.keys(currentNote)[0];
                audio_json[key].start(0);
                audio_json[key] = audioContext.createBufferSource();
                audio_json[key].buffer = audio_buffer_json[key];
                audio_json[key].connect(audioContext.destination);
                $('.key').css('background-color', 'white');
                $('.key' + key).css('background-color', 'red');
                if (songs[level].notes.length > 0){
                    window.setTimeout(playAudio, currentTime);
                }else{
                  setTimeout(function(){
                    console.log("@@@@@@@@@@@@@@@" + gameResult);
                    var result_json = {'level' : level, 'answers' : gameResult};
                    $.ajax({
                      type: "POST",
                      url: "/answers",
                      data: JSON.stringify(result_json),
                      contentType: 'application/json',
                      success: function(){
                      if (level < 5) {
                        window.location = '/level/' + parseInt(level) + 1;
                      }
                      },
                      error: function(){
                        // window.location = '/fail';
                      }
                    })
                  },1000);
                  document.getElementById('startbutton').disabled = false;

                }
            }
              window.setTimeout(playAudio, currentTime);
            }
            </script>

        </div>
</body></html>
